from fvcore.common.config import CfgNode
from Archs_3D import Register

CONFIGS = CfgNode()
CONFIGS.INTENSOR_SIZE = (224, 224)
CONFIGS.BATCH_SIZE = 32
CONFIGS.DEVICE = 'cuda'

CONFIGS.TRAINING = CfgNode()
CONFIGS.TRAINING.LOGDIR = './logdirs/mobiv2_deepbox3d'
CONFIGS.TRAINING.EPOCHS = 700
CONFIGS.TRAINING.CHECKPOINT_MODE = 'RESUME'#['PRETRAINED', 'RESUME', 'START']
CONFIGS.TRAINING.CHECKPOINT_FILE = './pretrained/mobilenetv2_pretrained.pkl'

CONFIGS.DATASET = CfgNode()
CONFIGS.DATASET.PATH = './datasets/data/kitti/training'
CONFIGS.DATASET.MEAN = [95.87739305, 98.76049672, 93.83309082]
CONFIGS.DATASET.DIM_MEAN = [[1.52607842, 1.62858147, 3.88396124], [2.20649159, 1.90197734, 5.07812564], [ 3.25207685,  2.58505032, 10.10703568], [1.76067766, 0.6602296 , 0.84220464], [1.27538462, 0.59506787, 0.80180995], [1.73712792, 0.59677122, 1.76338868], [ 3.52905882,  2.54368627, 16.09707843], [1.9074177 , 1.51386831, 3.57683128]]

CONFIGS.DATALOADER = CfgNode()
CONFIGS.DATALOADER.SAMPLER_TRAIN = 'TrainingSampler'
# Solver
# ---------------------------------------------------------------------------- #
CONFIGS.SOLVER = CfgNode()

# See detectron2/solver/build.py for LR scheduler options
CONFIGS.SOLVER.LR_SCHEDULER_NAME = "WarmupMultiStepLR"

CONFIGS.SOLVER.MAX_ITER = 1000000

CONFIGS.SOLVER.BASE_LR = 0.01

CONFIGS.SOLVER.MOMENTUM = 0.9

CONFIGS.SOLVER.WEIGHT_DECAY = 0.0001
# The weight decay that's applied to parameters of normalization layers
# (typically the affine transformation)
CONFIGS.SOLVER.WEIGHT_DECAY_NORM = 0.0

CONFIGS.SOLVER.GAMMA = 0.1
# The iteration number to decrease learning rate by GAMMA.
CONFIGS.SOLVER.STEPS = (50000, 80000)

CONFIGS.SOLVER.WARMUP_FACTOR = 1.0 / 1000
CONFIGS.SOLVER.WARMUP_ITERS = 1000
CONFIGS.SOLVER.WARMUP_METHOD = "linear"

CONFIGS.SOLVER.BIAS_LR_FACTOR = 1.0
CONFIGS.SOLVER.WEIGHT_DECAY_BIAS = CONFIGS.SOLVER.WEIGHT_DECAY
CONFIGS.SOLVER.EXCLUDE_SCOPE = ()
CONFIGS.SOLVER.LOAD_SOLVER = True

CONFIGS.MOBILENETV2 = CfgNode()

CONFIGS.EXTRANET = CfgNode()
CONFIGS.EXTRANET.NUMLAYERS = 2
CONFIGS.EXTRANET.NUMCONVS = 1
CONFIGS.EXTRANET.USE_INV_RES = False
CONFIGS.EXTRANET.EXPAND_RATIO = 1

CONFIGS.DEEPBOX3D = CfgNode()
CONFIGS.DEEPBOX3D.BINS = 2
CONFIGS.DEEPBOX3D.OVERLAP = 0.1
CONFIGS.DEEPBOX3D.OUT_CHANNELS = 256
CONFIGS.DEEPBOX3D.ALPHA = 0.6
CONFIGS.DEEPBOX3D.W = 0.4

CONFIGS.CAMERA = CfgNode()
CONFIGS.CAMERA.KMAT = [7.188560e+02, 0.000000e+00, 6.071928e+02, 4.538225e+01,
                       0.000000e+00, 7.188560e+02, 1.852157e+02, -1.130887e-01,
                       0.000000e+00, 0.000000e+00, 1.000000e+00, 3.779761e-03]

CONFIGS.DETECTOR = CfgNode()
CONFIGS.DETECTOR.CHECKPOINT = './weights/mobilenetv2_deepbox3d_model.pth'

CONFIGS.INPUT = CfgNode()
CONFIGS.INPUT.FORMAT = 'BGR'


@Register.Config.register('MOBI-V2-DEEPBOX3D')
def register():
    return CONFIGS